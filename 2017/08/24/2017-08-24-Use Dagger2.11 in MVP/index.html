<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Use Dagger2.11 in MVP · wkchen's blog</title><meta name="description" content="Use Dagger2.11 in MVP - wkchen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.tipdev.xyz/atom.xml" title="wkchen's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">TIMELINE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Use Dagger2.11 in MVP</h1><div class="post-info">Aug 24, 2017</div><div class="post-content"><p>前段时间在学习Google最新发布的架构<a href="https://developer.android.com/topic/libraries/architecture/index.html" target="_blank" rel="external">Android Architecture Components</a> 的时候时，使用到了Dagger2，一直以来对Dagger的使用都不怎么熟练。于是这次花了点时间学习了一下，一下是我对Dagger最新2.11版本的使用记录。</p>
<p>在这之前需要先了解</p>
<p>​    什么是依赖注入（Dependent injection）？</p>
<p>​    依赖注入的实现方式</p>
<p>​    依赖注入的好处</p>
<p>​    Dagger的知识要点</p>
<h3 id="1-依赖注入（DI）"><a href="#1-依赖注入（DI）" class="headerlink" title="1.依赖注入（DI）"></a>1.依赖注入（DI）</h3><p>​    当某个角色(可能<strong>是</strong>一个Java实例，调用者)需要另一个角色(另一个Java实例，被调用者)的协助时，在传统的程序设计过程中，通常由调用者来创建被调用者的实例。可以简单的理解为：一般情况下A类 依赖于 B类时，我们在A类中new 出一个实例，而依赖注入表示从外部创建好B类实例，直接传递给A类。</p>
<h3 id="2-注入方式"><a href="#2-注入方式" class="headerlink" title="2.注入方式"></a>2.注入方式</h3><p>依赖注入的实现方式：</p>
<ul>
<li><p>基于接口</p>
</li>
<li><p>基于set方法</p>
</li>
<li><p>基于构造函数</p>
</li>
<li><p>基于注解（Dagger2就是使用这种方式注入的@Inject）</p>
<p>​</p>
</li>
</ul>
<h3 id="3-依赖注入的好处"><a href="#3-依赖注入的好处" class="headerlink" title="3.依赖注入的好处"></a>3.依赖注入的好处</h3><p>​    两个字：解耦</p>
<h3 id="4-Dagger的知识要点"><a href="#4-Dagger的知识要点" class="headerlink" title="4.Dagger的知识要点"></a>4.Dagger的知识要点</h3><p>​    @Comonent  用来将@Inject 和@Module联系起来的桥梁，在@Module中获取依赖并且注入到@Inject</p>
<p>​    @Inject           Dagger2会实例化带有此注解的类</p>
<p>​    @Module       用于提供依赖</p>
<p>​        @Provide      </p>
<p>​        @Singleton   </p>
<p>​    @ContributesAndroidInjector（2.11新增）  用来生成对应的 Subcomponent</p>
<p>​    @Binds</p>
<h3 id="5-Dagger使用"><a href="#5-Dagger使用" class="headerlink" title="5.Dagger使用"></a>5.Dagger使用</h3><p>​    首先在build.gradle中添加如下dagger相关依赖</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">annotationProcessor <span class="string">'com.google.dagger:dagger-compiler:2.11'</span></div><div class="line">annotationProcessor <span class="string">'com.google.dagger:dagger-android-processor:2.11'</span></div><div class="line">implementation <span class="string">'com.google.dagger:dagger:2.11'</span></div><div class="line">implementation <span class="string">'com.google.dagger:dagger-android:2.11'</span></div><div class="line">implementation <span class="string">'com.google.dagger:dagger-android-support:2.11'</span></div></pre></td></tr></table></figure>
<p>​    在Application 中实现HasActivityInjector</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">HasActivityInjector</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    DispatchingAndroidInjector&lt;Activity&gt; dispatchingAndroidInjector;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        DaggerAppComontent.builder()</div><div class="line">            .application(<span class="keyword">this</span>)</div><div class="line">            .build()</div><div class="line">            .inject(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> AndroidInjector&lt;Activity&gt; <span class="title">activityInjector</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> dispatchingAndroidInjector;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    在Activity中实现HasFragmentInjector</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GankActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">HasFragmentInjector</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    DispatchingAndroidInjector&lt;Fragment&gt; dispatchingAndroidInjector;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        AndroidInjection.inject(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_gank);</div><div class="line"></div><div class="line">        getFragmentManager().beginTransaction()</div><div class="line">            .add(R.id.fragment, <span class="keyword">new</span> GankFragment())</div><div class="line">            .commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> AndroidInjector&lt;Fragment&gt; <span class="title">fragmentInjector</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> dispatchingAndroidInjector;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    创建NetworkModule</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkModule</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/*okhttp logging*/</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="function"><span class="keyword">public</span> HttpLoggingInterceptor <span class="title">provideHttpLogginInterceptor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpLoggingInterceptor().setLevel(HttpLoggingInterceptor.Level.BODY);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/*okhttp http header expample:Content-Type*/</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="function"><span class="keyword">public</span> HeaderInterceptor <span class="title">provideHeaderInterception</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HeaderInterceptor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/*okhttp config*/</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">provideOkHttpClient</span><span class="params">(HeaderInterceptor headerInterceptor, HttpLoggingInterceptor loggingInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">            .connectTimeout(<span class="number">30</span>, TimeUnit.SECONDS)</div><div class="line">            .addInterceptor(headerInterceptor)</div><div class="line">            .addInterceptor(loggingInterceptor)</div><div class="line">            .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/*retrofit gson*/</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="keyword">public</span> Converter.<span class="function">Factory <span class="title">provideConverterFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> GsonConverterFactory.create();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/*retrofit rxjava2*/</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="keyword">public</span> CallAdapter.<span class="function">Factory <span class="title">provideCallAdapterFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RxJava2CallAdapterFactory.create();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/*retrofit config*/</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Retrofit <span class="title">provideRetrofit</span><span class="params">(Converter.Factory converterFactory,</span></span></div><div class="line"><span class="function"><span class="params">                                    CallAdapter.Factory callAdapterFactory, OkHttpClient client)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">            .baseUrl(<span class="string">"http://gank.io/api/"</span>)</div><div class="line">            .addConverterFactory(converterFactory)</div><div class="line">            .addCallAdapterFactory(callAdapterFactory)</div><div class="line">            .client(client)</div><div class="line">            .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/*retrofit service*/</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="function"><span class="keyword">public</span> GankService <span class="title">provideGankService</span><span class="params">(Retrofit retrofit)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> retrofit.create(GankService.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    创建全局AppModule</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Module</span>(includes = &#123;</div><div class="line">    NetworkModule.class&#125;</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="function">Context <span class="title">provideContext</span><span class="params">(App app)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> app;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="meta">@Singleton</span></div><div class="line">    <span class="function">CompositeDisposable <span class="title">provideCompositeDisposable</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CompositeDisposable();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    创建统一管理依赖于AppComponent的Module添加的中间件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityModule</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@ContributesAndroidInjector</span>(modules = GankFragmentModule.class)</div><div class="line">    <span class="function"><span class="keyword">abstract</span> GankActivity <span class="title">contributeGankActivity</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    </p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">GankFragmentModule</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@ContributesAndroidInjector</span></div><div class="line">    <span class="function"><span class="keyword">abstract</span> GankFragment <span class="title">contributeGankFragment</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Binds</span></div><div class="line">    <span class="keyword">abstract</span> GankContract.<span class="function">GankPresenter <span class="title">bindsPresenter</span><span class="params">(GankPresenter presenter)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    最后创建AppComontent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="meta">@Component</span>(modules = &#123;</div><div class="line">    AndroidSupportInjectionModule.class,</div><div class="line">    AppModule.class,</div><div class="line">    ActivityModule.class</div><div class="line">&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComontent</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Component</span>.Builder</div><div class="line">    <span class="class"><span class="keyword">interface</span>  <span class="title">Builder</span></span>&#123;</div><div class="line">        <span class="meta">@BindsInstance</span></div><div class="line">        <span class="function">Builder <span class="title">application</span><span class="params">(App app)</span></span>;</div><div class="line">        <span class="function">AppComontent <span class="title">build</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(App app)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2017/11/07/2017-11-07-Let's 炫酷终端/" class="prev">PREV</a><a href="/2017/06/22/2017-06-22-服务端与客户端敏感数据通信的最佳实践/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://www.tipdev.xyz">wkchen</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>